# Фаза 3: Основной Конвейер Обработки (Core Processing Pipeline)

Теперь, когда у нас есть успешно реализованные Фазы 0-2 (базовая структура проекта, бэкенд-интеграция с внешними инструментами и пользовательский интерфейс), мы готовы к **Фазе 3: Основной Конвейер Обработки**. 

## Цель

Объединить отдельные бэкенд-сервисы, созданные в Фазе 1, в единый, хорошо организованный конвейер обработки видео. Создать систему управления заданиями, детальное отслеживание прогресса и надежную обработку ошибок.

## Фокус на Лучших Практиках (Май 2025)

* **Архитектурный паттерн "Конвейер"**: Реализация гибкого, настраиваемого конвейера для последовательной обработки видео.
* **Обработка Событий**: Эффективное использование системы подписки на события для отслеживания прогресса и статуса.
* **Управление Состоянием**: Надежное управление состоянием задач и процессов обработки.
* **Обработка Ошибок**: Всеобъемлющая и информативная стратегия обработки ошибок.
* **Эффективность Ресурсов**: Оптимизация использования системных ресурсов для длительных процессов.

## Шаги Реализации

### Шаг 3.1: Создание Координатора Конвейера Обработки

**Задача**: Разработать центральный модуль для координации всего процесса обработки видео, управляющий последовательностью вызовов различных сервисов.

**Действия**:
1. Создать `src/main/services/processingCoordinator.ts` с основным классом `ProcessingCoordinator`.
2. Реализовать метод `processVideo` с параметрами:
   ```typescript
   async processVideo({
     url, 
     downloadFolder, 
     originalLanguage, 
     targetLanguage,
     progressCallback
   }: ProcessingOptions): Promise<ProcessingResult>
   ```
3. Имплементировать полную последовательность шагов обработки:
   - Получение информации о видео через `ytDlpService.getVideoInfo`
   - Загрузка видео и аудио через `ytDlpService.downloadHighQualityComponents`
   - (Опционально) Разделение вокала и инструментала через `demucsService`
   - Транскрипция аудио через `openAiClient.transcribe`
   - Перевод текста через `openAiClient.translate`
   - Синтез речи через `openAiClient.synthesize` 
   - Объединение компонентов через `ffmpegService`
4. Добавить обработку ошибок с подробными сообщениями для каждого этапа.
5. Реализовать механизм отчетов о прогрессе через колбэки, сообщая о:
   - Процентном выполнении каждого шага
   - Переходах между шагами
   - Возникающих проблемах или предупреждениях

**Инструменты**: TypeScript, EventEmitter или пользовательская система событий.

**Результат**: Центральный координатор, способный управлять полным конвейером обработки, вызывая соответствующие сервисы в правильной последовательности.

### Шаг 3.2: Система Управления Заданиями

**Задача**: Создать систему для управления очередями заданий, позволяющую обрабатывать несколько видео параллельно или последовательно.

**Действия**:
1. Создать `src/main/services/jobManager.ts` с классом `JobManager`.
2. Реализовать функциональность:
   - Создание и постановка заданий в очередь
   - Назначение уникальных идентификаторов заданиям
   - Контроль выполнения (паузы, отмены, возобновления)
   - Ограничение количества одновременно выполняемых заданий
   - Сохранение состояния незавершенных заданий
3. Интегрировать `JobManager` с `ProcessingCoordinator`.
4. Обновить IPC методы для работы с заданиями:
   - `createJob`: создание нового задания
   - `getJobStatus`: получение статуса задания
   - `cancelJob`: отмена задания
   - `pauseJob`/`resumeJob`: пауза/возобновление задания
   - `getJobsList`: получение списка активных заданий

**Инструменты**: TypeScript, EventEmitter, electron-store для сохранения состояний.

**Результат**: Гибкая система очередей, позволяющая управлять множественными заданиями обработки видео.

### Шаг 3.3: Система Отчетов о Прогрессе

**Задача**: Разработать детальную систему отчетов о прогрессе, позволяющую UI отображать текущий статус обработки.

**Действия**:
1. Определить в `src/shared/processing-interfaces.ts` структуры для отчетов о прогрессе:
   ```typescript
   export interface ProcessingStep {
     id: string;
     name: string;
     status: 'waiting' | 'in_progress' | 'completed' | 'failed';
     progress: number; // 0-100
     message?: string;
     error?: Error;
   }

   export interface ProcessingProgress {
     jobId: string;
     overallProgress: number; // 0-100
     currentStep: string;
     steps: Record<string, ProcessingStep>;
     startTime: Date;
     estimatedEndTime?: Date;
   }
   ```
2. Создать в `ProcessingCoordinator` и `JobManager` механизмы для обновления состояния прогресса.
3. Добавить IPC канал для передачи обновлений прогресса в UI:
   ```typescript
   // В preload.ts
   ipcRenderer.on(Channels.PROGRESS_UPDATE, (event, progress: ProcessingProgress) => {
     // Отправка события в window
   });
   ```
4. Реализовать оценку оставшегося времени на основе завершенных этапов.

**Инструменты**: TypeScript, Electron IPC события.

**Результат**: Подробная система отчетов о прогрессе, позволяющая UI точно отображать статус обработки.

### Шаг 3.4: Логирование и Контрольные Точки

**Задача**: Внедрить систему логирования и контрольных точек для отслеживания прогресса и восстановления после ошибок.

**Действия**:
1. Интегрировать систему логирования (например, `electron-log` или `winston`).
2. Создать `src/main/services/checkpointManager.ts` для сохранения промежуточных результатов.
3. Реализовать сохранение контрольных точек после каждого значимого этапа:
   - После загрузки видео/аудио
   - После транскрипции
   - После перевода
   - После синтеза речи
4. Добавить функциональность восстановления обработки с последней контрольной точки.
5. Обеспечить детальное логирование всех операций, ошибок и предупреждений.

**Инструменты**: TypeScript, electron-log/winston, electron-store.

**Результат**: Надежная система логирования и контрольных точек, позволяющая отслеживать ход выполнения и восстанавливаться после сбоев.

### Шаг 3.5: Механизмы Восстановления

**Задача**: Разработать стратегии восстановления после ошибок и прерываний процесса обработки.

**Действия**:
1. Создать в `ProcessingCoordinator` логику для:
   - Обнаружения прерванных заданий при запуске приложения
   - Предложения пользователю возобновить прерванные задания
   - Восстановления обработки с последней контрольной точки
2. Реализовать стратегии повторных попыток для нестабильных операций:
   - Повторные попытки загрузки при проблемах с сетью
   - Повторные попытки для API вызовов с временными ошибками
   - Экспоненциальная задержка между повторами
3. Добавить автоматическое сохранение промежуточных результатов для быстрого восстановления.

**Инструменты**: TypeScript, стратегии повторных попыток, система контрольных точек.

**Результат**: Устойчивый к сбоям процесс обработки, способный восстанавливаться после ошибок и прерываний.

## Итог Фазы 3

К концу этой фазы у нас будет:

1. Полностью функциональный конвейер обработки видео, объединяющий все компоненты
2. Система управления заданиями с поддержкой очередей
3. Детальное отслеживание прогресса для каждого этапа обработки
4. Надежное логирование и механизмы восстановления
5. Эффективное использование системных ресурсов

Это создаст прочную основу для Фазы 4, где мы сосредоточимся на улучшении пользовательского интерфейса для отображения прогресса и результатов обработки.

## Ограничения на Данном Этапе

- Ограниченное взаимодействие с пользователем во время обработки (настройка параметров каждого этапа будет добавлена позже)
- Базовая оптимизация производительности (более глубокая оптимизация в Фазе 6)
- Без полноценной поддержки офлайн-режима (будет добавлена в Фазе 5) 